version: "3.8"

# Copyright (C) 2025 Marc Rivero LÃ³pez
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# SECURITY NOTE: This docker-compose configuration implements defense-in-depth
# security controls for malware analysis containers.

services:
  # Production r2inspect service
  r2inspect:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_TYPE=production
        - BUILDKIT_INLINE_CACHE=1
    image: r2inspect:latest
    container_name: r2inspect
    volumes:
      # Mount samples directory (read-only for security)
      - ./samples:/home/analyst/samples:ro
      # Mount output directory (read-write but limited)
      - ./output:/home/analyst/output:rw
      # Mount config directory for YARA rules (read-only)
      - ./config:/home/analyst/config:ro
      # Optional: Mount current directory for analysis (read-only)
      - ./:/workspace:ro
    environment:
      - PYTHONUNBUFFERED=1
      - R2_NOPLUGINS=1
      - R2PIPE_SPAWN=1
      # Limit memory for safety when analyzing malware
      - R2_MAXCORES=4
      - R2_MAXMEM=2048M
    # SECURITY FIX: Enhanced security options
    security_opt:
      - no-new-privileges:true
      # SECURITY FIX: Custom seccomp profile instead of unconfined
      # Provides minimum necessary syscalls for r2 debugging while blocking dangerous operations
      # References: CWE-250 (Execution with Unnecessary Privileges)
      - seccomp=security/seccomp-profile.json
    cap_drop:
      - ALL
    cap_add:
      # SECURITY: Minimal capabilities for debugging
      # SYS_PTRACE restricted by seccomp profile to safe operations only
      - SYS_PTRACE # Required for debugging (restricted by seccomp)
      # SECURITY FIX: Removed DAC_READ_SEARCH - not needed for normal operation
      # This reduces attack surface by limiting file system access bypasses
    # SECURITY FIX: Enable read-only root filesystem
    # Only /tmp, /home/analyst/output, and necessary directories are writable
    read_only: true
    tmpfs:
      # Secure temporary filesystem with security flags
      - /tmp:size=512M,noexec,nosuid,nodev,mode=1777
      # Writable home directory for Python cache and temporary analysis files
      - /home/analyst/.cache:size=256M,noexec,nosuid,nodev,uid=1000,gid=1000
    networks:
      - r2inspect_net
    restart: unless-stopped
    # Resource limits (defense against DoS)
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
          pids: 512 # Limit number of processes (prevent fork bombs)
        reservations:
          cpus: "0.5"
          memory: 512M

  # Development r2inspect service
  # SECURITY NOTE: Development container has slightly relaxed restrictions
  # for debugging purposes, but still maintains security boundaries
  r2inspect-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_TYPE=development
        - BUILDKIT_INLINE_CACHE=1
    image: r2inspect:dev
    container_name: r2inspect-dev
    volumes:
      # Mount samples directory (read-only)
      - ./samples:/home/analyst/samples:ro
      # Mount output directory (read-write)
      - ./output:/home/analyst/output:rw
      # Mount config directory for YARA rules (read-only)
      - ./config:/home/analyst/config:ro
      # Mount source code for development (read-write for development)
      - ./r2inspect:/app/r2inspect:rw
      - ./tests:/app/tests:rw
      # Mount workspace (read-write for development)
      - ./:/workspace:rw
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - R2_NOPLUGINS=1
      - R2PIPE_SPAWN=1
      - R2_MAXCORES=4
      - R2_MAXMEM=2048M
    # SECURITY FIX: Enhanced security options for development
    security_opt:
      - no-new-privileges:true
      # SECURITY FIX: Use custom seccomp profile instead of unconfined
      # Even in development, maintain security boundaries
      - seccomp=security/seccomp-profile.json
    cap_drop:
      - ALL
    cap_add:
      # SECURITY: Minimal capabilities
      - SYS_PTRACE # Required for debugging (restricted by seccomp)
      # SECURITY FIX: Removed DAC_READ_SEARCH for consistency
    # SECURITY NOTE: Development needs writable filesystem for code changes
    # In production, use read_only: true
    read_only: false
    tmpfs:
      # Secure temporary filesystem
      - /tmp:size=512M,noexec,nosuid,nodev,mode=1777
      - /home/analyst/.cache:size=256M,noexec,nosuid,nodev,uid=1000,gid=1000
    networks:
      - r2inspect_net
    ports:
      - "5000:5000" # For potential web interface
      - "8888:8888" # For Jupyter Lab
    profiles:
      - dev
    # Resource limits (more generous for development, but still limited)
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 4G
          pids: 1024 # Higher limit for development
        reservations:
          cpus: "1"
          memory: 1G

networks:
  r2inspect_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
