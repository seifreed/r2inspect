name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, macos-14, windows-latest]
        python-version: ["3.13", "3.14"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic-dev ssdeep

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libmagic ssdeep

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zipUrl = "https://github.com/ssdeep-project/ssdeep/releases/download/release-2.14.1/ssdeep-2.14.1-win32-binary.zip"
          $zipPath = "$env:RUNNER_TEMP\ssdeep-win32.zip"
          $extractRoot = "$env:RUNNER_TEMP\ssdeep"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $extractRoot -Force
          $binDir = Join-Path $extractRoot "ssdeep-2.14.1"
          "$binDir" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          & "$binDir\ssdeep.exe" -V
          pip install python-magic-bin

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Fetch test binaries
        shell: bash
        run: |
          git clone --depth 1 https://github.com/seifreed/r2inspect-test-binaries.git test-binaries
          python - <<'PY'
          from pathlib import Path
          import shutil

          repo = Path("test-binaries")
          dst = Path("samples/fixtures")
          dst.mkdir(parents=True, exist_ok=True)
          required = {
              "hello_pe.exe",
              "hello_elf",
              "hello_macho",
              "hello_macho_stripped",
              "edge_bad_pe.bin",
              "edge_high_entropy.bin",
              "edge_packed.bin",
              "edge_tiny.bin",
          }

          found = {}
          for item in repo.rglob("*"):
              if item.is_file() and item.name in required and item.name not in found:
                  found[item.name] = item

          missing = sorted(required - found.keys())
          if missing:
              raise SystemExit(f"Missing required test binaries: {missing}")

          for name, src in sorted(found.items()):
              shutil.copy2(src, dst / name)
          print(f"Copied {len(found)} fixtures from {repo} to {dst}")
          PY

      - name: Lint with ruff
        run: |
          ruff check r2inspect

      - name: Format check with black
        run: |
          black --check r2inspect

      - name: Security check with bandit
        run: |
          bandit -r r2inspect -f json -o bandit-report.json || true

      - name: Type check with mypy
        run: |
          mypy r2inspect || true

      - name: Test installation (Unix)
        if: runner.os != 'Windows'
        run: |
          pip install -e .
          r2inspect --help
          ssdeep -V

      - name: Test installation (Windows)
        if: runner.os == 'Windows'
        run: |
          python -c "import r2inspect, sys; print(r2inspect.__version__)"
          ssdeep -V

      - name: Run tests with coverage (unit + fast)
        run: |
          pytest -m "not requires_r2 and not slow" --cov=r2inspect --cov-report=term-missing --cov-fail-under=60

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: seifreed/r2inspect

  test-linux-x86-ssdeep-cli:
    runs-on: ubuntu-latest
    container:
      image: i386/python:3.13-slim
    steps:
      - name: Install ssdeep on linux/386
        run: |
          apt-get update
          apt-get install -y --no-install-recommends ssdeep

      - name: Validate ssdeep CLI on linux/386
        run: |
          ssdeep -V
          ssdeep -s /etc/hosts
